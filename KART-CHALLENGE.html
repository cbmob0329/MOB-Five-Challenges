<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Runner – 安定版</title>
<style>
  :root{ --stage-w:390px; --stage-h:700px; }
  html,body{height:100%;margin:0;background:#000;color:#fff;overscroll-behavior:none}
  #root{position:fixed;inset:0;display:grid;place-items:center}
  #phone{
    width:var(--stage-w);height:var(--stage-h);position:relative;overflow:hidden;
    background:#070b12;border:1px solid #0e1522;border-radius:16px;box-shadow:0 12px 40px rgba(0,0,0,.45);
    transform-origin:center center;
  }
  main.play{position:absolute;left:0;right:0;top:56px;bottom:96px}
  canvas#game{
    width:100%;height:100%;display:block;image-rendering:pixelated;background:transparent;
    will-change:transform; transform:translateZ(0);
  }
  /* HUD / UI は前回のまま省略（ここにHUD/ボタン用CSSを入れてください） */
</style>
</head>
<body>
<div id="root">
  <div id="phone">
    <main class="play"><canvas id="game" width="390" height="540"></canvas></main>
    <div id="overlay">…キャラ選択…</div>
    <div id="loading">…ロード中…</div>
    <div id="gameover"><button id="retryBtn">リトライ</button></div>
  </div>
</div>
<script>
(()=>{
  const phone=document.getElementById('phone');
  function fit(){ const s=Math.min(innerWidth/390, innerHeight/700); phone.style.transform=`scale(${s})`; }
  addEventListener('resize', fit, {passive:true}); fit();

  const cvs=document.getElementById('game'), ctx=cvs.getContext('2d',{alpha:true});
  const W=390,H=540; ctx.imageSmoothingEnabled=false;
  function setup(){ const dpr=Math.max(1,devicePixelRatio||1); cvs.width=W*dpr; cvs.height=H*dpr; ctx.setTransform(dpr,0,0,dpr,0,0); }
  setup();

  // ===== レイアウトロック制御 =====
  let layoutLocked=false;
  function hardReflow(){
    if(layoutLocked) return;
    fit(); setup();
    prev=performance.now(); // Δtリセット
  }
  const vv=window.visualViewport;
  if(vv){
    vv.addEventListener('resize', hardReflow,{passive:true});
    vv.addEventListener('scroll', hardReflow,{passive:true});
  }
  addEventListener('orientationchange', hardReflow,{passive:true});
  addEventListener('resize', hardReflow,{passive:true});

  // ===== Game State =====
  let player={x:80,y:H-100,w:48,h:48,vy:0,jumps:2,jumpMax:2};
  let gameOver=false, running=false, prev=0;

  const GRAV=1500, JUMP=540;
  function resetGame(){
    gameOver=false;
    player.y=H-100; player.vy=0; player.jumps=2; player.jumpMax=2;
    document.getElementById('gameover').style.display='none';
  }

  function start(){
    if(running) return;
    layoutLocked=true;     // ← プレイ中はレイアウト固定
    running=true;
    prev=performance.now();
    requestAnimationFrame(loop);
  }
  function endGame(){
    if(gameOver) return;
    gameOver=true;
    layoutLocked=false;    // ← リトライ待ち中は解放
    document.getElementById('gameover').style.display='block';
  }
  document.getElementById('retryBtn').onclick=()=>{
    resetGame();
    layoutLocked=true;     // リトライ後は再びロック
  };

  // ===== Loop =====
  function loop(t){
    const dt=Math.min(0.033,(t-prev)/1000); prev=t;
    if(!gameOver){
      player.vy+=GRAV*dt; player.y+=player.vy*dt;
      // 上方向クランプ（画面外に消えないように）
      if(player.y<-H*0.3) player.y=-H*0.3;
      const floor=H-100;
      if(player.y>floor){ player.y=floor; player.vy=0; player.jumps=player.jumpMax; }
    }

    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='#3af'; ctx.fillRect(player.x,player.y-player.h,player.w,player.h);

    requestAnimationFrame(loop);
  }
  start();

  // ===== エンジン効果例 =====
  function useEngine(){
    player.vy=-JUMP*1.5;   // 弱めに
    player.jumps=player.jumpMax;
  }
})();
</script>
</body>
</html>
