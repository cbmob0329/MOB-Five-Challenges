<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Osoji-Viran</title>
<meta name="theme-color" content="#0b0c10" />
<style>
  :root{ --bg:#0b0c10; --fg:#e9eef7; --dim:#9aa3b2; --accent:#13c4ff; --danger:#ff4d6d; --btn:#16202e; --glass:rgba(15,20,28,.65); }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);-webkit-font-smoothing:antialiased}
  body{display:flex;flex-direction:column}
  #app{position:fixed; inset:0; display:flex; flex-direction:column;}
  .topbar{flex:0 0 auto; display:flex; align-items:center; gap:12px;
    padding:10px calc(env(safe-area-inset-right,0) + 12px) 10px calc(env(safe-area-inset-left,0) + 12px);
    background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.05));
    backdrop-filter:blur(6px); z-index:5;}
  .pill{padding:6px 10px; border-radius:999px; background:var(--glass); font-size:14px}
  .pill strong{color:#fff}
  .spacer{flex:1}
  #wrap{position:relative; flex:1 1 auto;}
  #cv{position:absolute; inset:0; width:100%; height:100%; display:block; touch-action:none; background:#000}
  .modal{position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:10;
    background:rgba(0,0,0,.55); backdrop-filter:blur(4px);}
  .card{width:min(92vw,420px); background:linear-gradient(180deg,#121824,#0e131c); border:1px solid #27334a;
    border-radius:18px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.45)}
  .card h2{margin:8px 0 6px 0; font-size:22px}
  .muted{color:var(--dim); font-size:14px}
  .row{display:flex; gap:10px; align-items:center; margin-top:10px}
  .grow{flex:1}
  .cta{display:flex; gap:10px; margin-top:14px}
  .cta .btn{flex:1; height:48px; border-radius:14px; font-weight:700; background:var(--btn); border:1px solid #263246; color:#dfe7f5; display:flex; align-items:center; justify-content:center}
  .loader{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
    background:rgba(0,0,0,.55); z-index:9; gap:8px; text-align:center;}
  .bar{width:60%; height:8px; background:#263246; border-radius:999px; overflow:hidden}
  .bar>i{display:block; height:100%; width:0%; background:var(--accent)}
  *{ -webkit-tap-highlight-color: rgba(0,0,0,0); }
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="pill">TIME: <strong id="time">30.0</strong>s</div>
    <div class="pill">SCORE: <strong id="score">0</strong></div>
    <div class="spacer"></div>
    <div class="pill" id="hint">ドラッグで左右移動（高さ固定：上寄り）／タップで投下</div>
  </div>

  <div id="wrap">
    <canvas id="cv" width="0" height="0"></canvas>

    <div class="loader" id="loader">
      <div>読み込み中… <span id="ldTxt">0%</span></div>
      <div class="bar"><i id="ldBar"></i></div>
      <div class="muted" style="max-width:90vw">画像が欠けていてもプレースホルダーで開始します</div>
    </div>

    <div class="modal" id="result">
      <div class="card">
        <h2>結果</h2>
        <div class="row"><div class="grow">燃やした数</div><div><strong id="finalScore" style="font-size:22px">0</strong></div></div>
        <div class="muted">もう一度挑戦できます。</div>
        <div class="cta">
          <div class="btn" id="retry">RETRY</div>
          <div class="btn" id="share">SHARE</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(()=>{
const DPR = Math.max(1, window.devicePixelRatio || 1);
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d');
const timeEl = document.getElementById('time');
const scoreEl = document.getElementById('score');
const loader = document.getElementById('loader');
const ldTxt = document.getElementById('ldTxt');
const ldBar = document.getElementById('ldBar');
const modal = document.getElementById('result');
const retryBtn = document.getElementById('retry');
const shareBtn = document.getElementById('share');
const hint = document.getElementById('hint');

let W=0,H=0, groundY=0, baseY=0;
function resize(){
  const vw = window.innerWidth, vh = window.innerHeight;
  W = vw * DPR; H = vh * DPR;
  canvas.width = W; canvas.height = H;
  canvas.style.width = vw+"px"; canvas.style.height = vh+"px";
  groundY = H*0.86;
  baseY = H*0.25;
}
window.addEventListener('resize', resize, {passive:true});
resize();

// 画像ロード
function loadImgSafe(src, timeoutMs=4000){
  return new Promise((resolve)=>{
    const im = new Image(); let done=false;
    const finish = (ok)=>{ if(done) return; done=true; resolve({ok, img: ok?im:null, src}); };
    const timer = setTimeout(()=>finish(false), timeoutMs);
    im.onload = ()=>{ clearTimeout(timer); finish(true); };
    im.onerror = ()=>{ clearTimeout(timer); finish(false); };
    im.src = src + '?_=' + Date.now();
  });
}
const files = [
  'work.png','viran.png','tama.png','gomi.png','1.png','2.png','3.png',
  // 吹き出し素材
  'nera.png','otosi.png','koti.png','imada.png','isoge.png','totte.png'
];
const assets = {};
let started = false;
(async ()=>{
  let done=0;
  for(const f of files){
    loadImgSafe(f).then(r=>{
      done++; assets[f] = r.ok ? r.img : null;
      const p = Math.round(done/files.length*100);
      ldTxt.textContent = p + '%'; ldBar.style.width = p + '%';
      if(done===files.length) startGame();
    });
  }
  setTimeout(()=>{ if(!started) startGame(); }, 3000);
})();

// 入力
const input = { touching:false, id:null, lx:0, t0:0, moved:false };
const TAP_TIME = 220, TAP_MOVE = 12*DPR;
function viewToCanvas(x,y){ return { x:x*DPR, y:y*DPR }; }
canvas.addEventListener('touchstart', e=>{
  const t=e.changedTouches[0];
  input.touching=true; input.id=t.identifier; input.moved=false; input.t0=performance.now();
  input.lx=viewToCanvas(t.clientX,t.clientY).x;
},{passive:false});
canvas.addEventListener('touchmove', e=>{
  for(const t of e.changedTouches){ if(t.identifier===input.id){
    const p=viewToCanvas(t.clientX,t.clientY);
    if(Math.abs(p.x-input.lx)>TAP_MOVE) input.moved=true;
    input.lx=p.x; e.preventDefault(); break;
  }}
},{passive:false});
canvas.addEventListener('touchend', e=>{
  if(!input.touching) return;
  const dt=performance.now()-input.t0;
  if(!input.moved && dt<=TAP_TIME) tryDrop();
  input.touching=false; input.id=null;
},{passive:false});

// 状態
const world={timeLeft:30.0,score:0,running:false};
const player={x:W*0.22,y:baseY,w:84*DPR,h:84*DPR,stunned:0,blinkT:0,lockDrop:0,moveEaseX:0.12};
const fireball={active:false,x:0,y:0,vy:0,r:18*DPR};

// 吹き出し管理用
const RANDOM_BALLOONS = ['nera.png','otosi.png','koti.png'];
const FETCH_BALLOONS  = ['isoge.png','totte.png'];
const PAUSE_BALLOON   = 'imada.png';

function makeCarrier(kindIndex){
  const speed=(0.10+Math.random()*0.06)*DPR;
  const dir=Math.random()<0.5?-1:1;
  const startX=dir>0?-80*DPR:W+80*DPR;
  return{
    kind:kindIndex,x:startX,y:groundY-20*DPR,w:72*DPR,h:72*DPR,
    vx:speed*dir,baseSpeed:speed,hopT:Math.random()*6,
    hasBin:true,bin:{w:56*DPR,h:56*DPR,explode:0,exploding:false},
    state:'patrol',beh:'patrol',behT:Math.random()*2+2.5,
    pauseLeft:0,slowLeft:0,edgePause:0,
    bubble:{name:null,time:0,cd:rand(3.5,6.5),fetchCd:null}
  };
}
function rand(a,b){ return a + Math.random()*(b-a); }

// 各色2体ずつ（6体固定）
const carriers=[makeCarrier(1),makeCarrier(1),makeCarrier(2),makeCarrier(2),makeCarrier(3),makeCarrier(3)];

// ループ
let last=performance.now();
function startGame(){ if(started)return; started=true; loader.style.display='none'; world.running=true; last=performance.now(); requestAnimationFrame(loop); }
function loop(t){const dt=Math.min(0.05,(t-last)/1000);last=t;if(world.running)update(dt);draw();requestAnimationFrame(loop);}

function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

function update(dt){
  // タイマー
  world.timeLeft-=dt;if(world.timeLeft<=0){world.timeLeft=0;endGame();}
  timeEl.textContent=world.timeLeft.toFixed(1); scoreEl.textContent=world.score;

  // ロック
  if(player.lockDrop>0){ player.lockDrop = Math.max(0, player.lockDrop - dt); }
  hint.textContent = (player.lockDrop>0)
    ? `投下ロック中… ${player.lockDrop.toFixed(1)}s`
    : 'ドラッグで左右移動（高さ固定：上寄り）／タップで投下';

  // プレイヤー移動
  if(input.touching){
    const tx=clamp(input.lx-player.w/2,20*DPR,W-20*DPR-player.w);
    player.x += (tx-player.x)*player.moveEaseX;
  }
  player.y=baseY;
  if(player.stunned>0){ player.stunned = Math.max(0, player.stunned - dt); player.blinkT += dt*8; }

  // 火の玉
  if(fireball.active){
    fireball.vy+=0.0080*DPR; fireball.vy=Math.min(fireball.vy,2.4*DPR);
    fireball.y+=fireball.vy*dt*1000;
    // 命中
    for(const c of carriers){
      if(c.hasBin && !c.bin.exploding){
        const bx=c.x+(c.w-c.bin.w)/2;
        const by=(c.y-c.h)-c.bin.h-6*DPR; // 頭上
        const hit = !(fireball.x-fireball.r+fireball.r*2<bx || bx+c.bin.w<fireball.x-fireball.r ||
                      fireball.y-fireball.r+fireball.r*2<by || by+c.bin.h<fireball.y-fireball.r);
        if(hit){
          c.bin.exploding=true; c.bin.explode=0;
          fireball.active=false; world.score++;
        }
      }
    }
    // ミス（地面）
    if(fireball.active && fireball.y>groundY){
      fireball.active=false;
      player.stunned=2.0; player.blinkT=0;
      player.lockDrop=2.0;
    }
  }

  // 運搬キャラ
  for(const c of carriers){
    // ぴょん
    c.hopT+=dt*8; const hop=Math.abs(Math.sin(c.hopT))*8*DPR;

    // 破裂進行
    if(c.bin.exploding){
      c.bin.explode += dt*1.8;
      if(c.bin.explode>=1){
        c.bin.exploding=false; c.hasBin=false; c.state='fetch'; c.beh='patrol'; c.edgePause=0;
        // fetchに入ったら、最初の吹き出しタイミングを短めに
        c.bubble.fetchCd = rand(0.6, 1.2);
      }
    }

    // 吹き出しタイマー更新（共通）
    if(c.bubble.time>0) c.bubble.time = Math.max(0, c.bubble.time - dt);
    if(c.bubble.cd>0)   c.bubble.cd   = Math.max(0, c.bubble.cd   - dt);
    if(c.bubble.fetchCd!==null) c.bubble.fetchCd = Math.max(0, c.bubble.fetchCd - dt);

    if(c.state==='fetch'){
      // 補給へ（普通の速さ）
      const speed=Math.abs(c.baseSpeed)*1.0*DPR;
      c.x += speed * dt * 1000;

      // fetch中の吹き出し：isoge/totte を2.0〜3.2秒ごと
      if(c.bubble.fetchCd!==null && c.bubble.time<=0 && c.bubble.fetchCd<=0){
        c.bubble.name = FETCH_BALLOONS[(Math.random()<0.5)?0:1];
        c.bubble.time = 1.2;
        c.bubble.fetchCd = rand(2.0, 3.2);
      }

      if(c.x - c.w > W + 40*DPR){
        // 右外で補給→復帰（左へ）
        c.x = W + 120*DPR; c.vx = -Math.abs(c.baseSpeed);
        c.bin = {w:56*DPR,h:56*DPR,explode:0,exploding:false};
        c.hasBin = true; c.state = 'patrol';
        c.beh='patrol'; c.behT=rand(2.5,4.5);
        c.pauseLeft=0; c.slowLeft=0; c.edgePause=0;
        c.bubble.fetchCd=null; // fetch専用タイマ解除
      }
    }else{ // patrol
      // 端フェイント（消えないよう停止→反転）
      if(c.edgePause>0){
        c.edgePause -= dt;
        if(c.edgePause<=0){ c.vx = -c.vx; c.beh='patrol'; }
      }else{
        // ランダム行動：Pause/Slow
        c.behT -= dt;
        if(c.behT<=0 && !c.bin.exploding){
          if(Math.random()<0.5){ c.beh='pause'; c.pauseLeft=2.0; }
          else{ c.beh='slow'; c.slowLeft=1.2; c.vx = Math.sign(c.vx)*Math.abs(c.baseSpeed)*0.5; }
          c.behT = rand(3.0, 6.0);
        }

        if(c.beh==='pause'){
          // 停止中は移動しない & 吹き出し「imada」常時表示
          c.pauseLeft -= dt;
          if(c.pauseLeft>0){
            c.bubble.name = PAUSE_BALLOON;
            c.bubble.time = 0.2; // 毎フレーム延命して表示を維持
          }else{
            c.beh='patrol'; c.vx = Math.sign(c.vx)*Math.abs(c.baseSpeed);
          }
        }else{
          c.x += c.vx * dt * 1000; // patrol/slow の移動
        }

        if(c.beh==='slow'){
          c.slowLeft -= dt;
          if(c.slowLeft<=0){ c.beh='patrol'; c.vx = Math.sign(c.vx)*Math.abs(c.baseSpeed); }
        }

        // ランダム吹き出し（パトロール中）：3.5〜6.5秒ごとに1.2秒
        if(c.bubble.time<=0 && c.bubble.cd<=0){
          const pick = RANDOM_BALLOONS[Math.floor(Math.random()*RANDOM_BALLOONS.length)];
          c.bubble.name = pick; c.bubble.time = 1.2; c.bubble.cd = rand(3.5,6.5);
        }

        // 端処理：停止→反転（画面外に出さない）
        if(c.x < -60*DPR){ c.x = -60*DPR; c.edgePause = 0.30; }
        if(c.x + c.w > W + 60*DPR){ c.x = W + 60*DPR - c.w; c.edgePause = 0.30; }
      }
    }
    c.y = groundY - 20*DPR - hop;
  }
}

function tryDrop(){
  if(player.lockDrop>0 || fireball.active) return;
  fireball.active=true; fireball.x=player.x+player.w/2; fireball.y=player.y+player.h; fireball.vy=0.06*DPR;
}

// 描画
function draw(){
  ctx.clearRect(0,0,W,H);

  // 背景
  if(assets['work.png']){
    const img=assets['work.png']; const scale=(H/img.height); const w=img.width*scale;
    ctx.drawImage(img,0,0,w,H); if(w<W){ ctx.fillStyle="#111826"; ctx.fillRect(w,0,W-w,H); }
  }else{ ctx.fillStyle="#1a2230"; ctx.fillRect(0,0,W,H); }

  // キャラ＆吹き出し＆頭上ゴミ箱
  for(const c of carriers){
    const sx=c.x, sy=c.y-c.h;
    const im=assets[c.kind+'.png'];
    if(im) ctx.drawImage(im,sx,sy,c.w,c.h); else { ctx.fillStyle="#ccc"; ctx.fillRect(sx,sy,c.w,c.h); }

    // 吹き出し描画（追従）
    if(c.bubble.name && c.bubble.time>0){
      const bimg = assets[c.bubble.name];
      const bw = 96*DPR; // 吹き出し表示幅（固定）
      const bh = bimg ? (bw * (bimg.height / bimg.width)) : 60*DPR;
      let bx = sx + c.w*0.5 - bw*0.5;
      let by = sy - bh - 10*DPR;
      bx = clamp(bx, 4*DPR, W - bw - 4*DPR); // 画面外に出ない
      if(bimg){ ctx.drawImage(bimg, bx, by, bw, bh); }
      else{ ctx.fillStyle="rgba(255,255,255,.9)"; ctx.fillRect(bx,by,bw,bh); }
    }

    // ゴミ箱（頭上）
    if(c.hasBin){
      const bx=c.x+(c.w-c.bin.w)/2;
      const by=sy - c.bin.h;
      if(c.bin.exploding){
        // 赤スパイク爆発＋フェード
        const t=Math.min(1,c.bin.explode);
        if(assets['gomi.png']){
          ctx.save(); ctx.globalAlpha=1-t; ctx.drawImage(assets['gomi.png'],bx,by,c.bin.w,c.bin.h); ctx.restore();
        }else{ ctx.fillStyle=`rgba(200,200,200,${1-t})`; ctx.fillRect(bx,by,c.bin.w,c.bin.h); }
        ctx.save();
        ctx.globalCompositeOperation='lighter';
        ctx.fillStyle=`rgba(255,60,80,${0.65*(1-t)})`;
        ctx.beginPath();
        const cx=bx+c.bin.w/2, cy=by+c.bin.h/2;
        const spikes=18, inner=10*DPR*(1+t*0.6), outer=28*DPR*(1+t*1.5);
        for(let i=0;i<spikes*2;i++){
          const ang=(Math.PI*i)/spikes + t*5.6;
          const r=(i%2===0)?outer:inner;
          const px=cx+Math.cos(ang)*r, py=cy+Math.sin(ang)*r;
          if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
        }
        ctx.closePath(); ctx.fill();
        ctx.restore();
      }else{
        if(assets['gomi.png']) ctx.drawImage(assets['gomi.png'],bx,by,c.bin.w,c.bin.h);
        else { ctx.fillStyle="#999"; ctx.fillRect(bx,by,c.bin.w,c.bin.h); }
      }
    }
  }

  // 火の玉
  if(fireball.active){
    if(assets['tama.png']) ctx.drawImage(assets['tama.png'],fireball.x-fireball.r,fireball.y-fireball.r,fireball.r*2,fireball.r*2);
    else { ctx.fillStyle="#ffdd66"; ctx.beginPath(); ctx.arc(fireball.x,fireball.y,fireball.r,0,Math.PI*2); ctx.fill(); }
  }

  // プレイヤー（赤チカチカ演出）
  const blinking = player.stunned>0 && Math.floor(player.blinkT)%2===0;
  if(blinking){ ctx.globalAlpha=0.45; }
  if(assets['viran.png']) ctx.drawImage(assets['viran.png'],player.x,player.y,player.w,player.h);
  else { ctx.fillStyle="#6cf"; ctx.fillRect(player.x,player.y,player.w,player.h); }
  if(blinking){
    ctx.globalAlpha=1; ctx.strokeStyle="rgba(255,60,80,.95)"; ctx.lineWidth=4*DPR; ctx.strokeRect(player.x,player.y,player.w,player.h);
  }
}

// 終了/リトライ
function endGame(){ world.running=false; document.getElementById('finalScore').textContent=world.score; modal.style.display='flex'; }
function resetGame(){
  world.timeLeft=30.0; world.score=0; world.running=true;
  player.stunned=0; player.lockDrop=0; player.blinkT=0;
  fireball.active=false; fireball.vy=0;
  carriers.length=0;
  carriers.push( makeCarrier(1), makeCarrier(1), makeCarrier(2), makeCarrier(2), makeCarrier(3), makeCarrier(3) );
  modal.style.display='none';
}

// ユーティリティ
function tryDrop(){
  if(player.lockDrop>0 || fireball.active) return;
  fireball.active=true; fireball.x=player.x+player.w/2; fireball.y=player.y+player.h; fireball.vy=0.06*DPR;
}
})();
</script>
</body>
</html>
