<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Osoji-Viran</title>
<style>
  body{margin:0; background:#0b0c10; color:#fff; -webkit-font-smoothing:antialiased}
  #cv{position:absolute; inset:0; width:100%; height:100%; display:block; touch-action:none; background:#000}
  .topbar{position:fixed; top:0; left:0; right:0; display:flex; justify-content:space-between; padding:8px; background:rgba(0,0,0,.5); z-index:5}
  .pill{padding:4px 10px; border-radius:999px; background:rgba(20,20,30,.6)}
  .modal{position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.6); z-index:10}
  .card{background:#111; padding:20px; border-radius:12px; text-align:center}
</style>
</head>
<body>
<div class="topbar">
  <div class="pill">TIME: <strong id="time">60.0</strong></div>
  <div class="pill">SCORE: <strong id="score">0</strong></div>
</div>
<canvas id="cv"></canvas>
<div class="modal" id="result"><div class="card">
  <h2>結果</h2>
  <div>燃やした数 <strong id="finalScore">0</strong></div>
  <button onclick="resetGame()">RETRY</button>
</div></div>
<script>
(()=>{
const DPR=Math.max(1,window.devicePixelRatio||1);
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');
let W=0,H=0,groundY=0,baseY=0;
function resize(){
  W=innerWidth*DPR; H=innerHeight*DPR;
  cv.width=W; cv.height=H; cv.style.width=innerWidth+"px"; cv.style.height=innerHeight+"px";
  groundY=H*0.86; baseY=H*0.28; // ← プレイヤーの高さをもっと上へ
}
addEventListener('resize',resize);resize();

const assets={},files=['work.png','viran.png','tama.png','gomi.png','1.png','2.png','3.png'];
files.forEach(f=>{const im=new Image();im.src=f;assets[f]=im;});

const world={time:60,score:0,run:false};
const player={x:W*0.2,y:baseY,w:84*DPR,h:84*DPR,stun:0,lock:0,blink:0};
const fire={act:false,x:0,y:0,vy:0,r:18*DPR};
function carrier(kind){
  return {kind,x:W+100*DPR,y:groundY-20*DPR,w:72*DPR,h:72*DPR,vx:-0.12*DPR*1000,bin:{w:56*DPR,h:56*DPR,exp:0,ex:false}};
}
let carriers=[carrier(1),carrier(2),carrier(3)];

let inputX=null;
cv.addEventListener('touchstart',e=>{const t=e.changedTouches[0];inputX=t.clientX*DPR;}, {passive:true});
cv.addEventListener('touchmove',e=>{const t=e.changedTouches[0];inputX=t.clientX*DPR;}, {passive:true});
cv.addEventListener('touchend',e=>{drop();}, {passive:true});
cv.addEventListener('mousedown',e=>{inputX=e.clientX*DPR;});
cv.addEventListener('mousemove',e=>{if(e.buttons)inputX=e.clientX*DPR;});
cv.addEventListener('mouseup',()=>{drop();});

function drop(){
  if(player.lock>0||fire.act)return;
  fire.act=true;fire.x=player.x+player.w/2;fire.y=player.y+player.h*0.6;fire.vy=0.12*DPR; // 初速速め
}
function update(dt){
  world.time-=dt;if(world.time<=0){world.time=0;endGame();}
  document.getElementById('time').textContent=world.time.toFixed(1);
  document.getElementById('score').textContent=world.score;
  if(inputX!=null){player.x+= (inputX-player.w/2-player.x)*0.1;} // 左右移動ゆっくり
  player.y=baseY;
  if(player.stun>0){player.stun-=dt;player.blink+=dt*8;}
  if(player.lock>0)player.lock-=dt;
  if(fire.act){
    fire.vy+=0.012*DPR; if(fire.vy>2.5*DPR)fire.vy=2.5*DPR; // 落下加速速め
    fire.y+=fire.vy*dt*1000;
    for(const c of carriers){
      if(c.hasBin&&!c.bin.ex){
        const bx=c.x+(c.w-c.bin.w)/2,by=(c.y-c.h)-c.bin.h-6*DPR;
        if(!(fire.x+fire.r<bx||bx+c.bin.w<fire.x-fire.r||fire.y+fire.r<by||by+c.bin.h<fire.y-fire.r)){
          c.bin.ex=true;c.bin.exp=0;fire.act=false;world.score++; // 一つ焼却したら終了
          break;
        }
      }
    }
    if(fire.y>H)fire.act=false;
  }
  for(const c of carriers){
    c.x+=c.vx*dt;
    if(c.bin.ex){c.bin.exp+=dt*2;if(c.bin.exp>=1){c.bin.ex=false;c.hasBin=false;}}
    else c.hasBin=true;
    if(c.x<-c.w){c.x=W+100*DPR;}
  }
}
function draw(){
  ctx.clearRect(0,0,W,H);
  if(assets['work.png'].complete)ctx.drawImage(assets['work.png'],0,0,W,H);
  for(const c of carriers){
    const im=assets[c.kind+'.png'];if(im.complete)ctx.drawImage(im,c.x,c.y-c.h,c.w,c.h);
    if(c.hasBin){
      const bx=c.x+(c.w-c.bin.w)/2,by=(c.y-c.h)-c.bin.h-6*DPR;
      if(c.bin.ex){ctx.fillStyle=`rgba(255,60,80,${1-c.bin.exp})`;ctx.beginPath();ctx.arc(bx+c.bin.w/2,by+c.bin.h/2,30*DPR*c.bin.exp,0,Math.PI*2);ctx.fill();}
      else if(assets['gomi.png'].complete)ctx.drawImage(assets['gomi.png'],bx,by,c.bin.w,c.bin.h);
    }
  }
  if(fire.act){
    const im=assets['tama.png'];if(im.complete)ctx.drawImage(im,fire.x-fire.r,fire.y-fire.r,fire.r*2,fire.r*2);
  }
  const blink=player.stun>0&&Math.floor(player.blink)%2==0;
  if(blink)ctx.globalAlpha=0.4;
  const pv=assets['viran.png'];if(pv.complete)ctx.drawImage(pv,player.x,player.y,player.w,player.h);
  ctx.globalAlpha=1;
}
let last=performance.now();
function loop(t){const dt=(t-last)/1000;last=t;if(world.run)update(dt);draw();requestAnimationFrame(loop);}
function startGame(){world.run=true;requestAnimationFrame(loop);}
function endGame(){world.run=false;document.getElementById('finalScore').textContent=world.score;document.getElementById('result').style.display='flex';}
window.resetGame=function(){world.time=60;world.score=0;world.run=true;carriers=[carrier(1),carrier(2),carrier(3)];document.getElementById('result').style.display='none';};
startGame();
})();
</script>
</body>
</html>
