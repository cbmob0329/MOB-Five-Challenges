<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Osoji-Viran</title>
<meta name="theme-color" content="#0b0c10" />
<style>
  :root{
    --bg:#0b0c10; --fg:#e9eef7; --dim:#9aa3b2; --accent:#13c4ff; --danger:#ff4d6d;
    --btn:#16202e; --glass:rgba(15,20,28,.65);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);-webkit-font-smoothing:antialiased}
  body{display:flex;flex-direction:column}
  #app{position:fixed; inset:0; display:flex; flex-direction:column;}
  .topbar{flex:0 0 auto; display:flex; align-items:center; gap:12px;
    padding:10px calc(env(safe-area-inset-right,0) + 12px) 10px calc(env(safe-area-inset-left,0) + 12px);
    background:linear-gradient(180deg,rgba(0,0,0,.45),rgba(0,0,0,.05));
    backdrop-filter:blur(6px); z-index:5;}
  .pill{padding:6px 10px; border-radius:999px; background:var(--glass); font-size:14px}
  .pill strong{color:#fff}
  .spacer{flex:1}
  #wrap{position:relative; flex:1 1 auto;}
  #cv{position:absolute; inset:0; width:100%; height:100%; display:block; touch-action:none; background:#000}
  .modal{position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:10;
    background:rgba(0,0,0,.55); backdrop-filter:blur(4px);}
  .card{width:min(92vw,420px); background:linear-gradient(180deg,#121824,#0e131c); border:1px solid #27334a;
    border-radius:18px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,.45)}
  .card h2{margin:8px 0 6px 0; font-size:22px}
  .muted{color:var(--dim); font-size:14px}
  .row{display:flex; gap:10px; align-items:center; margin-top:10px}
  .grow{flex:1}
  .cta{display:flex; gap:10px; margin-top:14px}
  .cta .btn{flex:1; height:48px; border-radius:14px; font-weight:700; background:var(--btn); border:1px solid #263246; color:#dfe7f5; display:flex; align-items:center; justify-content:center}
  .loader{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column;
    background:rgba(0,0,0,.55); z-index:9; gap:8px; text-align:center;}
  .bar{width:60%; height:8px; background:#263246; border-radius:999px; overflow:hidden}
  .bar>i{display:block; height:100%; width:0%; background:var(--accent)}
  *{ -webkit-tap-highlight-color: rgba(0,0,0,0); }
</style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="pill">TIME: <strong id="time">30.0</strong>s</div>
    <div class="pill">SCORE: <strong id="score">0</strong></div>
    <div class="spacer"></div>
    <div class="pill" id="hint">ドラッグで左右移動（高さ固定：上寄り）／タップで投下</div>
  </div>
  <div id="wrap">
    <canvas id="cv" width="0" height="0"></canvas>
    <div class="loader" id="loader">
      <div>読み込み中… <span id="ldTxt">0%</span></div>
      <div class="bar"><i id="ldBar"></i></div>
      <div class="muted" style="max-width:90vw">画像が欠けていてもプレースホルダーで開始します</div>
    </div>
    <div class="modal" id="result">
      <div class="card">
        <h2>結果</h2>
        <div class="row"><div class="grow">燃やした数</div><div><strong id="finalScore" style="font-size:22px">0</strong></div></div>
        <div class="muted">もう一度挑戦できます。</div>
        <div class="cta">
          <div class="btn" id="retry">RETRY</div>
          <div class="btn" id="share">SHARE</div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
(()=>{
const DPR = Math.max(1, window.devicePixelRatio || 1);
const canvas = document.getElementById('cv');
const ctx = canvas.getContext('2d');
const timeEl = document.getElementById('time');
const scoreEl = document.getElementById('score');
const loader = document.getElementById('loader');
const ldTxt = document.getElementById('ldTxt');
const ldBar = document.getElementById('ldBar');
const modal = document.getElementById('result');
const retryBtn = document.getElementById('retry');
const shareBtn = document.getElementById('share');
const hint = document.getElementById('hint');

let W=0,H=0, groundY=0, baseY=0;
function resize(){
  const vw = window.innerWidth, vh = window.innerHeight;
  W = vw * DPR; H = vh * DPR;
  canvas.width = W; canvas.height = H;
  canvas.style.width = vw+"px"; canvas.style.height = vh+"px";
  groundY = H*0.86;
  baseY = H*0.25; // プレイヤーを上寄りに固定
}
window.addEventListener('resize', resize, {passive:true});
resize();

// ====== ゲーム状態 ======
const world = { timeLeft:30.0, score:0, running:false }; // ★30秒に変更

// ====== プレイヤー ======
const player = {
  x: W*0.22, y: baseY, w:84*DPR, h:84*DPR,
  stunned: 0, blinkT:0,
  lockDrop: 0,
  moveEaseX: 0.12,
  _bob: 0
};

// ====== 火の玉 ======
const fireball = { active:false, x:0,y:0, vx:0,vy:0, r:18*DPR, seeking:false, target:null };

// ====== キャリア ======
function makeCarrier(kindIndex){
  const speed = (0.10+Math.random()*0.06)*DPR;
  const dir = Math.random()<0.5?-1:1;
  const startX = dir>0 ? -80*DPR : W+80*DPR;
  return {kind:kindIndex,x:startX,y:groundY-20*DPR,w:72*DPR,h:72*DPR,
    vx:speed*dir,baseSpeed:speed,hopT:Math.random()*6,
    hasBin:true,bin:{w:56*DPR,h:56*DPR,explode:0,exploding:false},state:'patrol'};
}
const carriers=[makeCarrier(1),makeCarrier(2),makeCarrier(3)];

// ====== 入力処理 ======
const input={touching:false,id:null,lx:0};
canvas.addEventListener('touchstart',e=>{
  const t=e.changedTouches[0]; input.touching=true; input.id=t.identifier;
  input.lx=t.clientX*DPR; input.t0=performance.now(); input.moved=false;
},{passive:false});
canvas.addEventListener('touchmove',e=>{
  for(const t of e.changedTouches){if(t.identifier===input.id){input.lx=t.clientX*DPR;}}
},{passive:false});
canvas.addEventListener('touchend',e=>{
  if(!input.touching)return; const dt=performance.now()-input.t0;
  if(dt<250)tryDrop(); input.touching=false; input.id=null;
},{passive:false});

// ====== ゲームループ ======
let started=false,last=performance.now();
function startGame(){if(started)return; started=true; loader.style.display='none'; world.running=true; requestAnimationFrame(loop);}
setTimeout(()=>{if(!started)startGame();},2000);

function loop(t){const dt=Math.min(0.05,(t-last)/1000);last=t;if(world.running)update(dt);draw();requestAnimationFrame(loop);}

function update(dt){
  world.timeLeft-=dt;
  if(world.timeLeft<=0){world.timeLeft=0;endGame();}
  timeEl.textContent=world.timeLeft.toFixed(1);
  scoreEl.textContent=world.score;

  // プレイヤー移動
  if(input.touching){const tx=input.lx-player.w/2;player.x+= (tx-player.x)*player.moveEaseX;}
  player.y=baseY;

  // 火の玉
  if(fireball.active){
    if(!fireball.seeking){
      fireball.vy+=0.008*DPR; fireball.vy=Math.min(fireball.vy,2.4*DPR);
      fireball.y+=fireball.vy*dt*1000;
      for(const c of carriers){if(c.hasBin&&!c.bin.exploding){
        const bx=c.x+(c.w-c.bin.w)/2;const by=(c.y-c.h)-c.bin.h;
        if(fireball.x>bx&&fireball.x<bx+c.bin.w&&fireball.y>by&&fireball.y<by+c.bin.h){
          c.bin.exploding=true;fireball.active=false;world.score++;
        }}}
      if(fireball.y>groundY)fireball.active=false;
    }
  }

  // キャリア
  for(const c of carriers){c.hopT+=dt*8;c.x+=c.vx*dt*1000;
    if(c.x<-60*DPR)c.vx=Math.abs(c.vx);
    if(c.x>W+60*DPR)c.vx=-Math.abs(c.vx);}
}

function draw(){
  ctx.clearRect(0,0,W,H);
  // 背景
  ctx.fillStyle="#1a2230";ctx.fillRect(0,0,W,H);
  // キャリア
  ctx.fillStyle="#ccc";for(const c of carriers){ctx.fillRect(c.x,c.y-c.h,c.w,c.h);
    if(c.hasBin){ctx.fillStyle="#999";ctx.fillRect(c.x+c.w/4,c.y-c.h-40*DPR,40*DPR,40*DPR);ctx.fillStyle="#ccc";}}
  // 火の玉
  if(fireball.active){ctx.fillStyle="#ff0";ctx.beginPath();ctx.arc(fireball.x,fireball.y,fireball.r,0,Math.PI*2);ctx.fill();}
  // プレイヤー
  ctx.fillStyle="#6cf";ctx.fillRect(player.x,player.y,player.w,player.h);
}

function tryDrop(){
  if(fireball.active)return;
  fireball.active=true;fireball.x=player.x+player.w/2;fireball.y=player.y+player.h;
  fireball.vy=0.06*DPR;
}

function endGame(){world.running=false;document.getElementById('finalScore').textContent=world.score;modal.style.display='flex';}
retryBtn.addEventListener('click',()=>{world.timeLeft=30;world.score=0;world.running=true;modal.style.display='none';});
})();
</script>
</body>
</html>
