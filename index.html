<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>MOB Side-Scroll Runner (Mobile)</title>
<meta name="theme-color" content="#0b0c10" />
<style>
  :root{
    --bg:#0b0c10; --panel:#10151f; --panel2:#141b29; --fg:#e9eef7; --dim:#9aa3b2; --acc:#13c4ff; --acc2:#ff3e7f; --ok:#25d366; --warn:#ffb020;
    --hud-h:58px;        /* HUDの基本高さ */
    --pad:12px;          /* 内側余白 */
    --footer-h:96px;     /* 操作ボタンエリアの高さ */
    --maxw:420px;        /* PC閲覧時のスマホ風最大幅 */
  }

  /* iOSアドレスバー対策 */
  html,body { height:100%; }
  html { height:-webkit-fill-available; }
  body {
    margin:0; background:linear-gradient(180deg,#0b0c10 0%, #0c111a 60%, #0b0c10 100%);
    color:var(--fg); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Sans", "Yu Gothic", sans-serif;
    overscroll-behavior:none;
    touch-action:manipulation;
  }

  /* スマホ画面風の中央カラム（PC確認時もスマホ見え） */
  #app {
    position:fixed; inset:0;
    display:grid; place-items:center;
  }
  #phone {
    width:100%;
    max-width:var(--maxw);
    height:100dvh; /* 端末の表示高に追従 */
    display:grid; grid-template-rows:auto 1fr auto;
    background:transparent;
  }

  /* 上部HUD（キャンバス外、画面固定） */
  header.hud {
    position:sticky; top:0;
    height:calc(var(--hud-h) + env(safe-area-inset-top));
    padding:calc(env(safe-area-inset-top)) var(--pad) var(--pad);
    box-sizing:border-box;
    display:flex; align-items:flex-end; gap:8px; justify-content:space-between;
    background:linear-gradient(180deg, rgba(20,26,38,.9), rgba(16,21,31,.8));
    backdrop-filter: blur(6px);
    z-index:10; border-bottom:1px solid rgba(255,255,255,.06);
  }
  .hud .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill {
    background:#1b2233; padding:8px 10px; border-radius:999px; font-size:12px; color:#dfe7f5; letter-spacing:.2px; border:1px solid rgba(255,255,255,.05);
  }
  .boost {
    display:flex; align-items:center; gap:8px; min-width:160px;
  }
  .bar {
    position:relative; width:140px; height:10px; border-radius:999px; background:#0f1420; overflow:hidden; border:1px solid rgba(255,255,255,.08);
  }
  .bar > i { position:absolute; inset:0; width:0%; background:linear-gradient(90deg, var(--acc), #7af0ff); }

  /* 中央プレイ領域（キャンバス） */
  main.play {
    position:relative;
    padding:8px 0;
  }
  canvas#game {
    display:block; width:100%; height:100%;
    aspect-ratio:9/16; /* 9:16 に固定（スマホ風） */
    background:#060a12; border:1px solid rgba(255,255,255,.06); border-radius:12px;
    touch-action:none;
  }

  /* 下部操作（キャンバス外、画面固定） */
  footer.ctrl {
    position:sticky; bottom:0;
    height:calc(var(--footer-h) + env(safe-area-inset-bottom));
    padding:12px 12px calc(12px + env(safe-area-inset-bottom));
    background:linear-gradient(180deg, rgba(16,21,31,.8), rgba(10,14,22,.95));
    backdrop-filter: blur(6px);
    border-top:1px solid rgba(255,255,255,.06);
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px;
    z-index:10;
  }
  .btn {
    -webkit-tap-highlight-color: transparent;
    user-select:none; touch-action:manipulation;
    display:flex; align-items:center; justify-content:center; gap:8px;
    background:#1a2132; border:1px solid rgba(255,255,255,.08);
    color:#fff; padding:14px 10px; border-radius:16px; font-weight:700;
    box-shadow:0 4px 16px rgba(0,0,0,.25);
  }
  .btn:active { transform:translateY(1px); }
  .btn.primary { background:#1c2b44; border-color:#2e4f7a; }
  .btn.ok { background:#1d3b2b; border-color:#2a6d4f; }
  .btn.accent { background:#1a2b3e; border-color:#256787; }
  .btn[disabled] { opacity:.5; filter:grayscale(.2); }

  .slotWrap { display:flex; gap:10px; }
  .slot {
    width:56px; height:56px; border-radius:12px; background:#0f1726; border:1px dashed rgba(255,255,255,.25);
    display:grid; place-items:center; font-size:11px; color:#9fb3d9;
    position:relative; overflow:hidden;
  }
  .slot.full { border-style:solid; border-color:#3c6; background:#14231b; color:#d6f6df; }
  .slot .icon { font-size:18px; opacity:.9; }
  .slot .cap { position:absolute; inset:auto 6px 4px; font-size:10px; color:#9fb3d9; }

  /* スタート画面（キャラ選択） */
  #overlay {
    position:absolute; inset:0; display:grid; place-items:center; z-index:20;
    pointer-events:auto;
  }
  .card {
    width:min(92%, 360px); background:linear-gradient(180deg,#0e1320,#0b0f1a); border:1px solid rgba(255,255,255,.08);
    border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.4);
  }
  .title { font-weight:800; font-size:18px; margin:0 0 10px; letter-spacing:.3px; }
  .sub { color:var(--dim); font-size:13px; margin-bottom:12px; }
  .choices { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  .choice {
    background:#121a2a; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px;
    display:grid; gap:8px; justify-items:center; cursor:pointer; user-select:none;
  }
  .choice:active { transform:translateY(1px); }
  .choice img { width:72px; height:72px; object-fit:contain; background:#0c111a; border-radius:10px; border:1px solid rgba(255,255,255,.06); }
  .choice small { color:#a9b4c9; }

  /* 小さなバッジ */
  .badge { padding:4px 8px; border-radius:999px; font-size:11px; background:#172131; border:1px solid rgba(255,255,255,.08); color:#cfe7ff; }

  /* 画面が極端に低い場合、フッター高さを少し抑える */
  @media (max-height: 640px) {
    :root{ --footer-h:84px; --hud-h:52px; }
    .slot { width:52px; height:52px; }
  }
</style>
</head>
<body>
  <div id="app">
    <div id="phone">

      <!-- HUD（固定 / キャンバス外） -->
      <header class="hud" aria-label="ゲームHUD">
        <div class="row" id="statsLeft">
          <span class="pill" id="dist">距離 0 m</span>
          <span class="pill" id="speed">速度 0 km/h</span>
          <span class="pill" id="jump">ジャンプ 2</span>
          <span class="pill" id="coin">コイン 0</span>
        </div>
        <div class="row">
          <div class="pill boost">
            <span class="badge">BOOST</span>
            <div class="bar" aria-label="ブーストゲージ"><i id="boostFill" style="width:0%"></i></div>
          </div>
        </div>
      </header>

      <!-- プレイ領域（キャンバスのみ） -->
      <main class="play">
        <div style="position:relative">
          <canvas id="game" width="360" height="640" aria-label="ゲーム画面"></canvas>

          <!-- スタートオーバーレイ（キャラ選択） -->
          <div id="overlay">
            <div class="card">
              <p class="title">どちらか選択してスタート</p>
              <p class="sub">画像はリポジトリ直下に <code>VR.png</code> / <code>orange.png</code> を配置してください。</p>
              <div class="choices">
                <div class="choice" data-char="VR">
                  <img src="VR.png" alt="VR プレイヤー" onerror="this.style.opacity='.3'; this.alt='VR.png 未配置';">
                  <small>VR.png</small>
                </div>
                <div class="choice" data-char="orange">
                  <img src="orange.png" alt="orange プレイヤー" onerror="this.style.opacity='.3'; this.alt='orange.png 未配置';">
                  <small>orange.png</small>
                </div>
              </div>
              <p class="sub" style="margin-top:10px;">※ 画像が未配置でも色付きの代替シルエットで開始できます。</p>
            </div>
          </div>
        </div>
      </main>

      <!-- 操作（固定 / キャンバス外） -->
      <footer class="ctrl" aria-label="操作パネル">
        <button class="btn primary" id="btnJump" aria-label="ジャンプ">ジャンプ</button>
        <div class="slotWrap" aria-label="アイテムスロット">
          <div class="slot" id="slot0"><div class="icon">—</div><div class="cap">空</div></div>
          <div class="slot" id="slot1"><div class="icon">—</div><div class="cap">空</div></div>
        </div>
        <button class="btn accent" id="btnBoost" aria-label="ブースト">ブースト</button>
      </footer>

    </div>
  </div>

<script>
(() => {
  // ========= 基本参照 =========
  const cvs = document.getElementById('game');
  const ctx = cvs.getContext('2d');
  const overlay = document.getElementById('overlay');
  const choices = overlay.querySelectorAll('.choice');

  // HUD要素
  const elDist = document.getElementById('dist');
  const elSpeed = document.getElementById('speed');
  const elJump  = document.getElementById('jump');
  const elCoin  = document.getElementById('coin');
  const elBoost = document.getElementById('boostFill');

  // 操作ボタン
  const btnJump  = document.getElementById('btnJump');
  const btnBoost = document.getElementById('btnBoost');

  // アイテムスロット
  const slots = [
    document.getElementById('slot0'),
    document.getElementById('slot1'),
  ];

  // ========= レイアウト・スケーリング（キャンバス） =========
  // 9:16 アスペクトを維持しつつ、CSSで拡大縮小するため、内部解像度は固定でOK
  function fitCanvasToCss() {
    // CSSで aspect-ratio を9/16に固定してあるため、描画は内部解像度(360x640)基準でOK
    // ここでは何もしないが、将来デバイスピクセル比に応じてスケーリングしたい時はここを拡張
  }
  window.addEventListener('resize', fitCanvasToCss, {passive:true});
  fitCanvasToCss();

  // ========= ゲーム状態 =========
  const W = cvs.width, H = cvs.height;
  const GRAV = 1500;         // 重力 (px/s^2)
  const JUMP_V = 540;        // ジャンプ初速 (px/s)
  const FLOOR = H - 68;      // 地面Y
  const BASE_SPEED = 220;    // 基本移動速度 (px/s)
  const BOOST_SPEED = 480;   // ブースト時  (px/s)
  const BOOST_DRAIN = 24;    // ブースト消費 (ポイント/秒)
  const BOOST_FILL  = 10;    // 自然回復 (ポイント/秒)
  const BOOST_MAX   = 100;

  // 「px/s」を「km/h」に換算する係数（適当なスケール）
  // 1 px ≒ 0.02 m とみなす → 1 px/s ≒ 0.072 km/h
  const PXPS_TO_KMPH = 0.072;

  const player = {
    x: W*0.25, y: FLOOR, vy: 0,
    w: 48, h: 48,
    jumpsLeft: 2,
    onGround: true,
    img: null,
    fallbackColor: '#f63'
  };

  let running = false;
  let started = false;
  let gameTime = 0;
  let distancePx = 0;   // px累計（表示はm換算）
  let forwardSpeed = BASE_SPEED;
  let boost = 0;        // 0-100
  let boosting = false;
  let coins = 0;

  const items = [];     // ステージ上のアイテム
  const coinsOnField = []; // ステージ上のコイン
  const parallax = { x1:0, x2:0, x3:0 };

  // アイテムスロット（2枠）
  const itemSlots = [null, null]; // { type:'boost-pack' | 'shield', icon:'⚡' など }

  // ========= 画像ロード（任意、未配置でもOK） =========
  const imgVR = new Image(); imgVR.src = 'VR.png';
  const imgOrange = new Image(); imgOrange.src = 'orange.png';

  function setPlayerImage(which) {
    if (which === 'VR') {
      player.img = imgVR.complete ? imgVR : imgVR; // onload待ち不要（描画側でfallback）
      player.fallbackColor = '#6cf';
    } else {
      player.img = imgOrange.complete ? imgOrange : imgOrange;
      player.fallbackColor = '#f63';
    }
  }

  // ========= スタート（キャラ選択） =========
  choices.forEach(c => {
    c.addEventListener('click', () => {
      setPlayerImage(c.dataset.char);
      overlay.style.display = 'none';
      startGame();
    }, {passive:true});
  });

  // ========= 操作 =========
  function doJump() {
    if (!running) return;
    if (player.jumpsLeft > 0) {
      player.vy = -JUMP_V;
      player.onGround = false;
      player.jumpsLeft--;
      updateHUD();
    }
  }
  function toggleBoost(on) {
    boosting = !!on && boost > 0;
  }

  btnJump.addEventListener('pointerdown', (e)=>{ e.preventDefault(); doJump(); });
  btnBoost.addEventListener('pointerdown', (e)=>{ e.preventDefault(); toggleBoost(true); });
  btnBoost.addEventListener('pointerup',   (e)=>{ e.preventDefault(); toggleBoost(false); });
  btnBoost.addEventListener('pointercancel',(e)=>{ e.preventDefault(); toggleBoost(false); });

  // デスクトップ確認用（スマホは不要）
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space' || e.code === 'ArrowUp') doJump();
    if (e.code === 'ShiftLeft' || e.code === 'KeyB') toggleBoost(true);
  });
  window.addEventListener('keyup', (e)=>{
    if (e.code === 'ShiftLeft' || e.code === 'KeyB') toggleBoost(false);
  });

  // ========= 衝突判定 =========
  function aabb(a,b) {
    return (a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y);
  }

  // ========= スポーン =========
  function spawnCoin() {
    // 画面右側にランダム配置（簡易）
    const y = FLOOR - 20 - Math.random()*120;
    coinsOnField.push({ x: W + 20, y, w:14, h:14, v: 1 + (Math.random()<0.3?1:0) });
  }
  function spawnItem() {
    // アイテムは2種類のどちらか
    const kinds = [
      { type:'boost-pack', icon:'⚡', color:'#6cf', desc:'ブースト回復' },
      { type:'shield',     icon:'🛡️', color:'#9f6', desc:'（将来用）' }
    ];
    const kind = kinds[Math.floor(Math.random()*kinds.length)];
    const y = FLOOR - 24 - Math.random()*120;
    items.push({ x: W + 40, y, w:20, h:20, kind });
  }

  // ========= アイテム取得処理 =========
  function pickupItem(kind) {
    // 空きスロット検索
    const idx = itemSlots.findIndex(s => s === null);
    if (idx === -1) {
      flashSlotsFull();
      return false;
    }
    itemSlots[idx] = kind;
    renderSlots();
    return true;
  }
  function flashSlotsFull() {
    slots.forEach((s,i)=>{
      s.animate([{filter:'brightness(1)'},{filter:'brightness(2)'},{filter:'brightness(1)'}], {duration:420});
    });
  }
  function renderSlots() {
    itemSlots.forEach((it,i)=>{
      const s = slots[i];
      s.innerHTML = '';
      if (it) {
        s.classList.add('full');
        const icon = document.createElement('div'); icon.className='icon'; icon.textContent = it.icon;
        const cap  = document.createElement('div'); cap.className='cap';  cap.textContent  = it.type === 'boost-pack' ? '充填' : '保管';
        s.append(icon, cap);
        s.onclick = () => useItem(i);
      } else {
        s.classList.remove('full');
        const icon = document.createElement('div'); icon.className='icon'; icon.textContent = '—';
        const cap  = document.createElement('div'); cap.className='cap';  cap.textContent  = '空';
        s.append(icon, cap);
        s.onclick = null;
      }
    });
  }
  function useItem(i) {
    const it = itemSlots[i];
    if (!it) return;
    if (it.type === 'boost-pack') {
      boost = Math.min(BOOST_MAX, boost + 40);
    }
    // 使ったら消費
    itemSlots[i] = null;
    renderSlots();
    updateHUD();
  }

  // ========= HUD更新 =========
  function updateHUD() {
    const distM = Math.floor(distancePx * 0.02); // px→m換算（1px=0.02m）
    elDist.textContent = `距離 ${distM} m`;

    const kmh = Math.round(forwardSpeed * PXPS_TO_KMPH);
    elSpeed.textContent = `速度 ${kmh} km/h`;

    elJump.textContent = `ジャンプ ${player.jumpsLeft}`;
    elCoin.textContent = `コイン ${coins}`;

    const pct = Math.max(0, Math.min(100, boost));
    elBoost.style.width = pct + '%';

    btnBoost.disabled = (pct<=0);
  }

  // ========= ループ =========
  let prev = 0;
  function loop(t) {
    if (!running) return;
    const now = t || performance.now();
    const dt = Math.min(0.033, (now - prev) / 1000); // 安定化
    prev = now;

    gameTime += dt;

    // スピード
    if (boosting && boost > 0) {
      forwardSpeed = BOOST_SPEED;
      boost -= BOOST_DRAIN * dt;
      if (boost <= 0) { boost = 0; boosting = false; }
    } else {
      forwardSpeed = BASE_SPEED;
      boost = Math.min(BOOST_MAX, boost + BOOST_FILL * dt);
    }

    // パララックス背景
    parallax.x1 -= forwardSpeed * 0.25 * dt;
    parallax.x2 -= forwardSpeed * 0.50 * dt;
    parallax.x3 -= forwardSpeed * 1.00 * dt;
    [ 'x1','x2','x3' ].forEach(k => { if (parallax[k] <= -W) parallax[k] += W; });

    // プレイヤー物理
    player.vy += GRAV * dt;
    player.y  += player.vy * dt;
    if (player.y > FLOOR) {
      player.y = FLOOR;
      player.vy = 0;
      if (!player.onGround) {
        player.onGround = true;
        player.jumpsLeft = 2; // 着地でリセット
      }
    }

    // フィールド更新（右→左へ流れる）
    const flow = forwardSpeed * dt;
    coinsOnField.forEach(c => c.x -= flow);
    while (coinsOnField.length && coinsOnField[0].x < -30) coinsOnField.shift();

    items.forEach(it => it.x -= flow);
    while (items.length && items[0].x < -30) items.shift();

    // スポーン（簡易ランダム）
    if (Math.random() < 0.02) spawnCoin();
    if (Math.random() < 0.006) spawnItem();

    // 取得判定
    // コイン
    for (let i=coinsOnField.length-1; i>=0; i--) {
      const c = coinsOnField[i];
      if (aabb(player, c)) {
        coins += c.v; // 1 or 2
        // コイン取得で微量ブースト回復
        boost = Math.min(BOOST_MAX, boost + 4 * c.v);
        coinsOnField.splice(i,1);
      }
    }
    // アイテム
    for (let i=items.length-1; i>=0; i--) {
      const it = items[i];
      if (aabb(player, it)) {
        if (pickupItem(it.kind)) {
          items.splice(i,1);
        } else {
          // 満杯時は拾えない→そのまま流す
        }
      }
    }

    // 距離加算
    distancePx += flow;

    // 描画
    draw();

    // HUD更新
    updateHUD();

    requestAnimationFrame(loop);
  }

  // ========= 描画 =========
  function draw() {
    ctx.clearRect(0,0,W,H);

    // 背景レイヤ（簡易グラデ＋パララックス矩形）
    // sky
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#08101c');
    g.addColorStop(1,'#0a1322');
    ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

    // 遠景ビル
    ctx.fillStyle = '#0d1a2a';
    for (let i=0;i<2;i++){
      const ox = (i===0?parallax.x1:parallax.x2);
      const step = 60*(i===0?1.2:1);
      for (let x=ox; x< W+step; x+=step) {
        const h = 60 + (i===0?40:80) * (0.3 + Math.random()*0.7);
        ctx.fillRect(x, H-160-h, 40, h);
      }
    }

    // 地面
    ctx.fillStyle = '#122238';
    ctx.fillRect(0, FLOOR+16, W, H-(FLOOR+16));
    // 路面ライン
    ctx.strokeStyle = 'rgba(255,255,255,.06)';
    ctx.beginPath();
    ctx.moveTo(0, FLOOR+0.5); ctx.lineTo(W, FLOOR+0.5); ctx.stroke();

    // コイン
    coinsOnField.forEach(c=>{
      ctx.beginPath();
      ctx.arc(c.x + c.w/2, c.y + c.h/2, c.w/2, 0, Math.PI*2);
      ctx.fillStyle = '#ffd84d';
      ctx.fill();
      // 輪郭
      ctx.strokeStyle = '#e7b400';
      ctx.lineWidth = 1;
      ctx.stroke();
      // 輝き
      ctx.fillStyle = 'rgba(255,255,255,.8)';
      ctx.beginPath(); ctx.arc(c.x + 4, c.y + 4, 3, 0, Math.PI*2); ctx.fill();
    });

    // アイテム
    items.forEach(it=>{
      ctx.fillStyle = it.kind.color;
      ctx.fillRect(it.x, it.y, it.w, it.h);
      ctx.fillStyle = '#021019';
      ctx.font = 'bold 12px system-ui';
      ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(it.kind.icon, it.x + it.w/2, it.y + it.h/2 + 1);
    });

    // プレイヤー
    if (player.img && player.img.complete && player.img.naturalWidth>0) {
      // 画像が正方形でない可能性を考慮して内接矩形で描画
      const sz = Math.min(player.w, player.h);
      ctx.drawImage(player.img, player.x, player.y - player.h, sz, sz);
    } else {
      // 代替描画（シルエット）
      ctx.fillStyle = player.fallbackColor;
      ctx.fillRect(player.x, player.y - player.h, player.w, player.h);
      ctx.fillStyle = '#00000030';
      ctx.fillRect(player.x+6, player.y - player.h+6, player.w-12, player.h-12);
    }

    // 影
    ctx.fillStyle = 'rgba(0,0,0,.25)';
    ctx.beginPath();
    ctx.ellipse(player.x + player.w/2, FLOOR+12, player.w*0.45, 6, 0, 0, Math.PI*2);
    ctx.fill();
  }

  // ========= ゲーム開始 =========
  function startGame() {
    if (started) return;
    started = true;
    running = true;
    boost = 60; // 初期ゲージ
    renderSlots();
    updateHUD();
    prev = performance.now();
    requestAnimationFrame(loop);
  }

  // ========= スクロール/ダブルタップ防止 =========
  ['touchstart','touchmove','gesturestart'].forEach(ev=>{
    document.addEventListener(ev, (e)=>{
      if (e.target.closest('button, .choice')) return; // UI操作は許可
      e.preventDefault();
    }, {passive:false});
  });

})();
</script>
</body>
</html>
