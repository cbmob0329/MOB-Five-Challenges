<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>MOB CART Runner</title>
<style>
  :root{--fg:#fff;--pill:#2b2f3a;--btn:#1b1f27;--btn2:#2b303b;}
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Sans','Yu Gothic',sans-serif}
  #wrap{position:fixed;inset:0;overflow:hidden}
  #stage{position:absolute;left:0;top:0;width:414px;height:896px;transform-origin:0 0}
  #cv{display:block;touch-action:none;background:#000}

  /* HUD */
  .hud{position:absolute;inset:0;pointer-events:none}
  .top{position:absolute;left:10px;right:10px;top:8px;display:flex;gap:10px;align-items:center}
  .pill{background:var(--pill);border-radius:999px;padding:6px 12px;font-weight:700;font-size:14px}
  .mid{position:absolute;left:10px;right:10px;top:42px;display:flex;align-items:center;gap:10px}
  .gauge{height:16px;background:#303847;border:1px solid #475268;border-radius:999px;overflow:hidden;width:100%}
  .gauge i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2bd,#8ef)}
  .bottom{position:absolute;left:10px;right:10px;bottom:calc(12px + env(safe-area-inset-bottom));display:grid;grid-template-columns:1fr 64px 64px 1fr;gap:10px;pointer-events:none;z-index:5}
  .bbtn{pointer-events:auto;background:var(--btn2);border-radius:16px;padding:14px 12px;font-weight:900;text-align:center}
  .slot{pointer-events:auto;height:56px;border-radius:12px;border:1px dashed #666;background:rgba(255,255,255,.06);display:grid;place-items:center}
  .slot img{max-width:90%;max-height:90%;image-rendering:pixelated}
  .slot.empty{opacity:.35}
  .hidden{display:none !important}

  .center{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;z-index:6}
  .panel{pointer-events:auto;width:min(94%,560px);background:rgba(15,18,26,.92);border-radius:18px;padding:18px}
  .card{flex:1 1 48%;border:1px solid #2c3444;border-radius:14px;padding:10px;display:grid;place-items:center}
  .card img{width:110px;height:auto;image-rendering:pixelated}
  .sel{outline:3px solid #2bd36b}
  .count{position:absolute;inset:0;display:grid;place-items:center;font-size:60px;font-weight:900;text-shadow:0 4px 16px #000;z-index:7}
  .cutin{position:absolute;inset:auto 50% 40% 50%;transform:translate(-50%,0);z-index:7}
  .cutin img{width:min(80vw,520px);height:auto;display:block;opacity:0;animation:cut 2s ease forwards;image-rendering:pixelated}
  @keyframes cut{0%{opacity:0}15%{opacity:1}85%{opacity:1}100%{opacity:0}}

  /* OP */
  #opOverlay{position:fixed;inset:0;background:#000;display:grid;place-items:center;z-index:20}
  #opOverlay img{width:min(72vw,520px);height:auto;image-rendering:pixelated}
</style>
</head>
<body>
<div id="wrap">
  <div id="stage">
    <canvas id="cv"></canvas>
    <div class="hud">
      <div class="top">
        <div class="pill" id="distPill">距離 0 m</div>
        <div class="pill" id="spdPill">速度 0 km/h</div>
        <div class="pill" id="jumpPill">ジャンプ ×2</div>
        <div class="pill" id="coinPill">コイン 0/10</div>
      </div>
      <div class="mid"><div class="gauge"><i id="boostFill"></i></div></div>
      <div class="bottom">
        <div class="bbtn" id="btnJump">ジャンプ</div>
        <div class="slot empty" id="slot1"></div>
        <div class="slot empty" id="slot2"></div>
        <div class="bbtn" id="btnBoost">ブースト</div>
      </div>
      <div class="center">
        <div class="panel hidden" id="panelChar">
          <h2>キャラクター選択</h2>
          <div style="display:flex;gap:10px">
            <div class="card sel" data-char="orange"><img src="orange.png"><div>オレンジ</div></div>
            <div class="card" data-char="VR"><img src="VR.png"><div>VR</div></div>
          </div>
          <div class="btn" id="charStart">スタート</div>
        </div>
      </div>
      <div class="count hidden" id="count">3</div>
      <div class="cutin hidden" id="cutin"><img id="cutinImg" src=""></div>
    </div>
  </div>
</div>
<div id="opOverlay"><img src="op.png"></div>

<script>
(() => {
  const DESIGN_W=414, DESIGN_H=896;
  const stage=document.getElementById('stage');
  function scaleFit(){
    const vw=window.innerWidth, vh=(visualViewport?visualViewport.height:window.innerHeight);
    const s=Math.max(vw/DESIGN_W,vh/DESIGN_H); // cover
    const tx=(vw-DESIGN_W*s)/2, ty=(vh-DESIGN_H*s)/2;
    stage.style.transform=`translate(${tx}px,${ty}px) scale(${s})`;
  }
  addEventListener('resize',scaleFit); if(visualViewport) visualViewport.addEventListener('resize',scaleFit); scaleFit();

  const cv=document.getElementById('cv'), cx=cv.getContext('2d');
  cv.width=DESIGN_W; cv.height=DESIGN_H;
  const W=DESIGN_W,H=DESIGN_H;
  const files={doro:'do-ro.png',hatake:'hatake2.png',sora:'sora.PNG',corn:'corn.PNG',orange:'orange.png',VR:'VR.png',dokan:'dokan.png',jumpdai:'jumpdai.png'};
  const IM={}; for(const[k,v]of Object.entries(files)){const img=new Image();img.src=v;IM[k]=img;}

  const CORN_Y_OFFSET=4, ROAD_TOP_Y=H*0.82|0, ROAD_BASELINE_OFFSET=12;
  const GROUND_Y=()=>ROAD_TOP_Y+ROAD_BASELINE_OFFSET;

  const player={x:W*0.2,y:0,w:48,h:54,vy:0,onGround:true,sprite:'orange'};
  let state=0,selected='orange';

  // OP 2秒後にキャラ選択
  setTimeout(()=>{document.getElementById('opOverlay').style.display='none';document.getElementById('panelChar').classList.remove('hidden');state=1;},2000);
  document.getElementById('charStart').onclick=()=>{if(state===1){state=2;startCountdown();}};

  function startCountdown(){
    let n=3;const el=document.getElementById('count');el.textContent=n;el.classList.remove('hidden');
    const tm=setInterval(()=>{n--;if(n>0)el.textContent=n;else if(n===0)el.textContent='GO';else{clearInterval(tm);el.classList.add('hidden');state=3;}},700);
  }

  function loop(){
    render();requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);

  function render(){
    cx.clearRect(0,0,W,H);
    if(IM.sora)cx.drawImage(IM.sora,0,0,W,H);
    const gy=GROUND_Y();
    if(IM.hatake)cx.drawImage(IM.hatake,0,gy-200, W,200);
    if(IM.doro)cx.drawImage(IM.doro,0,ROAD_TOP_Y,W,H-ROAD_TOP_Y);

    if(IM[player.sprite])cx.drawImage(IM[player.sprite],player.x,gy-player.h,player.w,player.h);
    if(IM.corn)cx.drawImage(IM.corn,200,gy-78+CORN_Y_OFFSET,78,78);
    if(IM.dokan)cx.drawImage(IM.dokan,300,gy-60,66,60);
    if(IM.jumpdai){
      // 三角形ジャンプ台
      const x=400,y=gy; cx.beginPath();cx.moveTo(x,y);cx.lineTo(x+120,y);cx.lineTo(x,y-36);cx.closePath();
      cx.fillStyle=cx.createPattern(IM.jumpdai,'repeat');cx.fill();
    }
  }
})();
</script>
</body>
</html>
