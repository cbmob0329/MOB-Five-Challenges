<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no">
<title>MOB CART Runner</title>
<style>
  :root{--pill:#2b2f3a;--btn2:#2b303b;}
  html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Hiragino Sans','Yu Gothic',sans-serif;}
  #wrap{position:fixed;inset:0;overflow:hidden;background:#000;}

  /* Canvasのみ拡大 */
  #stage{position:absolute;left:0;top:0;width:414px;height:896px;transform-origin:0 0;z-index:1;}
  #cv{display:block;width:414px;height:896px;background:#000;touch-action:none;}

  /* HUD固定 */
  .hud{position:fixed;inset:0;z-index:5;}
  .pill{background:var(--pill);border-radius:999px;padding:6px 12px;font-weight:700;font-size:14px}
  .topbar{position:fixed;left:12px;right:12px;top:calc(6px + env(safe-area-inset-top));display:flex;gap:10px;}
  .gauge-wrap{position:fixed;left:12px;right:12px;top:44px;}
  .gauge{height:16px;background:#303847;border:1px solid #475268;border-radius:999px;overflow:hidden}
  .gauge i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#2bd,#8ef)}
  .bottombar{position:fixed;left:12px;right:12px;bottom:calc(12px + env(safe-area-inset-bottom));
             display:grid;grid-template-columns:1fr 64px 64px 1fr;gap:10px;z-index:6;}
  .bbtn{background:var(--btn2);border-radius:16px;padding:14px 12px;font-weight:900;text-align:center;user-select:none}
  .slot{height:56px;border-radius:12px;border:1px dashed #666;background:rgba(255,255,255,.06);display:grid;place-items:center}
  .slot img{max-width:90%;max-height:90%;image-rendering:pixelated}
  .slot.empty{opacity:.35}
  .hidden{display:none!important}

  /* 中央パネル */
  .overlay{position:fixed;inset:0;display:grid;place-items:center;z-index:7;}
  .panel{
    background:rgba(15,18,26,.92);
    border-radius:18px;
    padding:18px;
    max-width:90%;   /* ← 追加 */
    max-height:90%;  /* ← 追加 */
    overflow:auto;   /* ← 追加 */
  }
  .card{flex:1 1 48%;border:1px solid #2c3444;border-radius:14px;padding:10px;display:grid;place-items:center;cursor:pointer}
  .sel{outline:3px solid #2bd36b}
  .btn{background:#1b1f27;border:1px solid #323a49;border-radius:14px;padding:12px 16px;font-weight:800;text-align:center;margin-top:12px;cursor:pointer}

  .count{position:fixed;inset:0;display:grid;place-items:center;font-size:60px;font-weight:900;text-shadow:0 4px 16px #000;z-index:8}
  #opOverlay{position:fixed;inset:0;background:#000;display:grid;place-items:center;z-index:20}
  #opOverlay img{width:min(72vw,520px);height:auto;image-rendering:pixelated}
</style>
</head>
<body>
<div id="wrap">
  <div id="stage"><canvas id="cv"></canvas></div>

  <!-- HUD固定 -->
  <div class="hud">
    <div class="topbar">
      <div class="pill" id="distPill">距離 0 m</div>
      <div class="pill" id="spdPill">速度 0 km/h</div>
    </div>
    <div class="gauge-wrap"><div class="gauge"><i id="boostFill"></i></div></div>
    <div class="bottombar">
      <div class="bbtn" id="btnJump">ジャンプ</div>
      <div class="slot empty" id="slot1"></div>
      <div class="slot empty" id="slot2"></div>
      <div class="bbtn" id="btnBoost">ブースト</div>
    </div>
  </div>

  <!-- キャラ選択 -->
  <div class="overlay hidden" id="panelChar">
    <div class="panel">
      <h2>キャラクター選択</h2>
      <div style="display:flex;gap:10px">
        <div class="card sel" data-char="orange"><img src="orange.png"><div>オレンジ</div></div>
        <div class="card" data-char="VR"><img src="VR.png"><div>VR</div></div>
      </div>
      <div class="btn" id="charStart">スタート</div>
    </div>
  </div>

  <div class="count hidden" id="count">3</div>
</div>
<div id="opOverlay"><img src="op.png" alt=""></div>

<script>
(() => {
  const DESIGN_W=414, DESIGN_H=896;
  const stage=document.getElementById('stage');
  function scaleCover(){
    const vw=innerWidth, vh=(visualViewport?visualViewport.height:innerHeight);
    const s=Math.max(vw/DESIGN_W, vh/DESIGN_H);
    const tx=(vw-DESIGN_W*s)/2, ty=(vh-DESIGN_H*s)/2;
    stage.style.transform=`translate(${tx}px,${ty}px) scale(${s})`;
  }
  addEventListener('resize',scaleCover); if(visualViewport) visualViewport.addEventListener('resize',scaleCover); scaleCover();

  const cv=document.getElementById('cv'), cx=cv.getContext('2d');
  cv.width=DESIGN_W; cv.height=DESIGN_H;

  const files={sora:'sora.PNG',hatake:'hatake2.png',doro:'do-ro.png',corn:'corn.PNG',dokan:'dokan.png',jumpdai:'jumpdai.png',orange:'orange.png',VR:'VR.png'};
  const IM={}; for(const[k,v] of Object.entries(files)){IM[k]=new Image(); IM[k].src=v;}

  const ROAD_TOP_Y=(DESIGN_H*0.82)|0, ROAD_BASELINE_OFFSET=12;
  const GROUND_Y=()=>ROAD_TOP_Y+ROAD_BASELINE_OFFSET;
  const CORN_Y_OFFSET=4;

  let state=0, selected='orange'; const ST={TITLE:0,CHARSEL:1,COUNT:2,RUN:3};
  const player={x:80,y:0,w:48,h:54,vy:0,onGround:true,sprite:'orange'};

  setTimeout(()=>{document.getElementById('opOverlay').style.display='none';document.getElementById('panelChar').classList.remove('hidden');state=ST.CHARSEL;},2000);

  document.getElementById('panelChar').addEventListener('click',e=>{
    const c=e.target.closest('.card'); if(c){selected=c.dataset.char;document.querySelectorAll('.card').forEach(x=>x.classList.toggle('sel',x===c));}
  });
  document.getElementById('charStart').onclick=()=>{
    if(state!==ST.CHARSEL) return;
    player.sprite=selected;
    document.getElementById('panelChar').classList.add('hidden');
    startCountdown();
  };

  document.getElementById('btnJump').onclick=()=>{if(state===ST.RUN&&player.onGround){player.vy=-14;player.onGround=false;}};

  function startCountdown(){
    state=ST.COUNT; let n=3; const el=document.getElementById('count'); el.textContent=n; el.classList.remove('hidden');
    const gy=GROUND_Y(); player.y=gy-player.h;
    const tm=setInterval(()=>{n--; if(n>0)el.textContent=n; else if(n===0)el.textContent='GO';
      else{clearInterval(tm);el.classList.add('hidden');state=ST.RUN;}},700);
  }

  const world={scrollX:0,speed:4}; const W=DESIGN_W,H=DESIGN_H;

  function loop(){update();render();requestAnimationFrame(loop);} requestAnimationFrame(loop);

  function update(){
    if(state!==ST.RUN)return;
    world.scrollX+=world.speed;
    player.vy+=0.72; player.y+=player.vy;
    const gy=GROUND_Y()-player.h;
    if(player.y>=gy){player.y=gy;player.vy=0;player.onGround=true;}
  }

  function drawTiled(img,y,spd,h){
    if(!img.complete)return;
    const iw=img.width||256, w=iw, x0=-(world.scrollX*spd%w)|0;
    for(let x=x0-w;x<W+w;x+=w)cx.drawImage(img,x,y,w,h);
  }

  function render(){
    cx.clearRect(0,0,W,H);
    const gy=GROUND_Y();
    drawTiled(IM.sora,0,0.1,H);
    drawTiled(IM.hatake,gy-200,0.5,200);
    drawTiled(IM.doro,ROAD_TOP_Y,1,H-ROAD_TOP_Y);
    if(IM[player.sprite].complete)cx.drawImage(IM[player.sprite],player.x,player.y,player.w,player.h);
    if(IM.corn.complete)cx.drawImage(IM.corn,200,gy-78+CORN_Y_OFFSET,78,78);
    if(IM.dokan.complete)cx.drawImage(IM.dokan,300,gy-60,66,60);
    if(IM.jumpdai.complete){cx.beginPath();cx.moveTo(400,gy);cx.lineTo(520,gy);cx.lineTo(400,gy-36);cx.closePath();cx.fillStyle=cx.createPattern(IM.jumpdai,'repeat');cx.fill();}
  }
})();
</script>
</body>
</html>
